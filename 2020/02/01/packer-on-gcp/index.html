<!doctype html><html lang=en-us>
<head>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge,chrome=1">
<title>Packer on GCP &#183; Bear Su's Blog - Running Bear!!! </title>
<meta name=generator content="Hugo 0.92.0">
<meta name=description content="Running Bear!!!">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.bear-su.dev/images/bear.jpeg">
<meta name=twitter:title content="Packer on GCP">
<meta name=twitter:description content="
unsplash-logoAntony Xia
想要將在 GCP 建置 GCE VM Image 的過程自動化，又不想寫一堆針對 GCP Service  操作的 Script。可以使用 Hashicorp Packer 來協助一鍵建置。">
<meta property="og:title" content="Packer on GCP">
<meta property="og:description" content="
unsplash-logoAntony Xia
想要將在 GCP 建置 GCE VM Image 的過程自動化，又不想寫一堆針對 GCP Service  操作的 Script。可以使用 Hashicorp Packer 來協助一鍵建置。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.bear-su.dev/2020/02/01/packer-on-gcp/"><meta property="og:image" content="https://blog.bear-su.dev/images/bear.jpeg"><meta property="article:section" content>
<meta property="article:published_time" content="2020-02-01T12:00:00+08:00">
<meta property="article:modified_time" content="2020-02-01T12:00:00+08:00">
<link href rel=alternate type=application/rss+xml title="Bear Su's Blog">
<link href rel=feed type=application/rss+xml title="Bear Su's Blog">
<meta itemprop=name content="Packer on GCP">
<meta itemprop=description content="
unsplash-logoAntony Xia
想要將在 GCP 建置 GCE VM Image 的過程自動化，又不想寫一堆針對 GCP Service  操作的 Script。可以使用 Hashicorp Packer 來協助一鍵建置。"><meta itemprop=datePublished content="2020-02-01T12:00:00+08:00">
<meta itemprop=dateModified content="2020-02-01T12:00:00+08:00">
<meta itemprop=wordCount content="510"><meta itemprop=image content="https://blog.bear-su.dev/images/bear.jpeg">
<meta itemprop=keywords content>
<link href="https://fonts.googleapis.com/css?family=Lato:400" rel=stylesheet>
<link rel=stylesheet href=https://blog.bear-su.dev/css/style.css>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Bear Su\u0027s Blog","url":"https:\/\/blog.bear-su.dev\/2020\/02\/01\/packer-on-gcp\/"}</script>
</head>
<body>
<header class=gheader>
<div class=container>
<nav class=navbar>
<div class=navbar-brand>
<a class=navbar-item href=https://blog.bear-su.dev>
<p class=brand>Bear Su's Blog</p>
</a>
<div class="navbar-burger burger" data-target=navMenubd-example>
<span></span>
<span></span>
<span></span>
</div>
</div>
<div id=navMenubd-example class=navbar-menu>
<div class=navbar-start>
<a class=navbar-item href=/categories/>
Categories
</a>
<a class=navbar-item href=https://github.com/timfanda35>
GitHub
</a>
<a class=navbar-item href=https://www.linkedin.com/in/bearsu>
Linkedin
</a>
<a class=navbar-item href=https://twitter.com/Fandayo>
Twitter
</a>
</div>
</div>
</nav>
</div>
</header>
<div class=main-content>
<div class=container>
<article class=post>
<header class=post-header>
<h1 class=title>Packer on GCP</h1>
<div class=meta>
<time class=pub-time datetime=2020-02-01T12:00:00+08:00>
2020.02.01
</time>
<div class=terms>
<div class=categories>
<a class=categories-item href=/categories/gcp>gcp</a>
<a class=categories-item href=/categories/gce>gce</a>
<a class=categories-item href=/categories/hashicorp>hashicorp</a>
<a class=categories-item href=/categories/packer>packer</a>
</div>
</div>
</div>
</header>
<div class=post-body>
<div class=toc-wrap>
<h2>Table of Contents</h2>
<nav id=TableOfContents>
<ul>
<li><a href=#設定>設定</a></li>
<li><a href=#建置>建置</a></li>
<li><a href=#補完設定>補完設定</a></li>
</ul>
</nav>
</div>
<p><img src=/images/2020-02-01/packer-on-gcp/cover.jpg alt></p>
<p><a style="background-color:#000;color:#fff;text-decoration:none;padding:4px 6px;font-family:-apple-system,BlinkMacSystemFont,san francisco,helvetica neue,Helvetica,Ubuntu,Roboto,Noto,segoe ui,Arial,sans-serif;font-size:12px;font-weight:700;line-height:1.2;display:inline-block;border-radius:3px" href="https://unsplash.com/@shadejay?utm_medium=referral&utm_campaign=photographer-credit&utm_content=creditBadge" target=_blank rel="noopener noreferrer" title="Download free do whatever you want high-resolution photos from Antony Xia"><span style="display:inline-block;padding:2px 3px"><svg xmlns="http://www.w3.org/2000/svg" style="height:12px;width:auto;position:relative;vertical-align:middle;top:-2px;fill:#fff" viewBox="0 0 32 32"><title>unsplash-logo</title><path d="M10 9V0h12v9H10zm12 5h10v18H0V14h10v9h12v-9z"/></svg></span><span style="display:inline-block;padding:2px 3px">Antony Xia</span></a></p>
<p>想要將在 GCP 建置 GCE VM Image 的過程自動化，又不想寫一堆針對 GCP Service 操作的 Script。可以使用 Hashicorp Packer 來協助一鍵建置。</p>
<p>Packer 將會自動化以下步驟：</p>
<ol>
<li>建立 VM</li>
<li>執行操作</li>
<li>保留硬碟，刪除 VM</li>
<li>用硬碟建立 Image</li>
<li>刪除硬碟</li>
</ol>
<p><em><strong>本文假設使用者已安裝並熟悉 Google Cloud SDK(gcloud)</strong></em></p>
<p>本文將以建置一個 Nginx 的 GCE Image 為例。</p>
<p>首先先到 Hashicorp 下載對應平台的 Packer 執行檔：<a href=https://www.packer.io/>https://www.packer.io/</a></p>
<p>我使用的平台是 macOS。</p>
<p>給予執行權限並放置到常用的路徑底下，以 Linux 來說如： <code>/usr/local/bin/</code></p>
<p>建立專案目錄</p>
<pre><code>mkdir gce-image-nginx-demo
cd gce-image-nginx-demo
</code></pre>
<h2 id=設定>設定 <a href=#%e8%a8%ad%e5%ae%9a>¶</a></h2>
<hr>
<p>編輯 <code>template.json</code></p>
<pre><code>{
  &quot;variables&quot;: {
    &quot;project_id&quot;: &quot;{{env `GCP_PROJECT_ID`}}&quot;,
    &quot;region&quot;: &quot;asia-east1&quot;,
    &quot;zone&quot;: &quot;asia-east1-b&quot;
  },
  &quot;builders&quot;: [
    {
      &quot;type&quot;: &quot;googlecompute&quot;,
      &quot;project_id&quot;: &quot;{{user `project_id`}}&quot;,
      &quot;image_name&quot;: &quot;nginx-demo-{{timestamp}}&quot;,
      &quot;source_image&quot;: &quot;centos-7-v20191210&quot;,
      &quot;ssh_username&quot;: &quot;packer&quot;,
      &quot;zone&quot;: &quot;{{user `zone`}}&quot;
    }
  ],
  &quot;provisioners&quot;: []
}
</code></pre>
<p><code>template.json</code> 分為三個部分：</p>
<ol>
<li>variables：定義可重複利用的變數</li>
<li>builders：要建置 Image 的平台設定，Packer 支援：<a href=https://www.packer.io/docs/builders/index.html>https://www.packer.io/docs/builders/index.html</a></li>
<li>provisioners：定義如何設定 VM 的方法</li>
</ol>
<p>以下表示取得環境變數 <code>GCP_PROJECT_ID</code> 的值</p>
<pre><code>&quot;{{env `GCP_PROJECT_ID`}}&quot;
</code></pre>
<p>以下表示取得在 <code>variables</code> 區塊中定義的變數的值</p>
<pre><code>&quot;{{user `project_id`}}&quot;
&quot;{{user `zone`}}&quot;
</code></pre>
<p><code>timestamp</code> 是 Packer 預設的 Function，可以參考 <a href=https://www.packer.io/docs/templates/engine.html#functions>https://www.packer.io/docs/templates/engine.html#functions</a></p>
<pre><code>&quot;prometheus-{{timestamp}}&quot;
</code></pre>
<p>在 <code>variables</code> 區塊中，我定義了 GCP 常用的三個變數：</p>
<ol>
<li>project id</li>
<li>region</li>
<li>zone</li>
</ol>
<p>在 <code>builders</code> 區塊中，建置 GCP Linux 的 VM 時，需要設定如下：</p>
<pre><code>&quot;builders&quot;: [
  {
    &quot;type&quot;: &quot;googlecompute&quot;,
    &quot;project_id&quot;: &quot;{{user `project_id`}}&quot;,
    &quot;image_name&quot;: &quot;prometheus-{{timestamp}}&quot;,
    &quot;source_image&quot;: &quot;centos-7-v20191210&quot;,
    &quot;ssh_username&quot;: &quot;packer&quot;,
    &quot;zone&quot;: &quot;{{user `zone`}}&quot;
  }
]
</code></pre>
<ul>
<li><code>type</code>: 固定為 <code>googlecompute</code></li>
<li><code>project_id</code>: 要建置 GCE VM Image 的 GCP 專案 ID</li>
<li><code>image_name</code>: 要建置 GCE VM Image 的名稱，為避免名稱衝突，我通常會加上 timestamp</li>
<li><code>source_image</code>: 要建置 GCE VM Image 的原始 GCE VM Image，將以此 Image 作為基底進行建置，名稱可以從 GCE Image 的頁面查看</li>
<li><code>ssh_username</code>: 讓 Packer 遠端登入操作的使用者名稱</li>
<li><code>zone</code>: GCE VM 是 zone 層級的資源，所以需要指定 VM 要建立在哪個 zone</li>
</ul>
<p>預設 Packer 會使用 Machine type 為 <code>n1-standard-1</code> 的 VM 進行建置，可以參考文件調整：</p>
<p><a href=https://www.packer.io/docs/builders/googlecompute.html#optional->https://www.packer.io/docs/builders/googlecompute.html#optional-</a></p>
<h2 id=建置>建置 <a href=#%e5%bb%ba%e7%bd%ae>¶</a></h2>
<hr>
<p>因為在 <code>template.json</code> 中有使用到環境變數，所以我們可以先宣告：</p>
<pre><code>export GCP_PROJECT_ID=&quot;$(gcloud config get-value core/project)&quot;
</code></pre>
<p>然後執行以下指令檢查格式</p>
<pre><code>packer validate template.json
</code></pre>
<p>如果沒問題，會看到以下輸出結果：</p>
<pre><code>Template validated successfully.
</code></pre>
<p>在正式使用時，建議使用 Service Account 執行 Packer。本文為了方便，改採用以下指令讓 Packer 取得授權操作：</p>
<pre><code>gcloud auth application-default login
</code></pre>
<p>這個指令將產生一份 <code>$HOME/.config/gcloud/application_default_credentials.json</code>，不需要的時候就可以刪除。</p>
<p>使用 Service Account 請參考：</p>
<p><a href=https://www.packer.io/docs/builders/googlecompute.html#precedence-of-authentication-methods>https://www.packer.io/docs/builders/googlecompute.html#precedence-of-authentication-methods</a></p>
<p>執行以下指令進行建置：</p>
<pre><code>packer build template.json
</code></pre>
<p>輸出結果如下：</p>
<pre><code>googlecompute: output will be in this color.

==&gt; googlecompute: Checking image does not exist...
==&gt; googlecompute: Creating temporary SSH key for instance...
==&gt; googlecompute: Using image: centos-7-v20191210
==&gt; googlecompute: Creating instance...
    googlecompute: Loading zone: asia-east1-b
    googlecompute: Loading machine type: n1-standard-1
    googlecompute: Requesting instance creation...
    googlecompute: Waiting for creation operation to complete...
    googlecompute: Instance has been created!
==&gt; googlecompute: Waiting for the instance to become running...
    googlecompute: IP: xxx.xxx.xxx.xxx
==&gt; googlecompute: Using ssh communicator to connect: xxx.xxx.xxx.xxx
==&gt; googlecompute: Waiting for SSH to become available...
==&gt; googlecompute: Connected to SSH!
==&gt; googlecompute: Deleting instance...
    googlecompute: Instance has been deleted!
==&gt; googlecompute: Creating image...
==&gt; googlecompute: Deleting disk...
    googlecompute: Disk has been deleted!
Build 'googlecompute' finished.

==&gt; Builds finished. The artifacts of successful builds are:
--&gt; googlecompute: A disk image was created: nginx-demo-1580527798
</code></pre>
<p>接著就能在 GCE Image 頁面中找到剛剛建置的 Image。</p>
<p>為了少打字與方便重複利用，我會用 <code>Makefile</code> 來執行建置。編輯 <code>Makefile</code></p>
<pre><code>build:
	GCP_PROJECT_ID=$(shell gcloud config get-value core/project) \
	packer build template.json
</code></pre>
<p>之後只要執行 <code>make</code> 就好。</p>
<p>但我們並沒有安裝 Nginx，所以只是一個只有基底的 Image。</p>
<h2 id=補完設定>補完設定 <a href=#%e8%a3%9c%e5%ae%8c%e8%a8%ad%e5%ae%9a>¶</a></h2>
<hr>
<p>編輯 <code>index.html</code></p>
<pre><code>&lt;h1&gt;Hello, Packer!&lt;/h1&gt;
</code></pre>
<p>編輯 <code>template.json</code></p>
<pre><code>{
  &quot;variables&quot;: {
    &quot;project_id&quot;: &quot;{{env `GCP_PROJECT_ID`}}&quot;,
    &quot;region&quot;: &quot;asia-east1&quot;,
    &quot;zone&quot;: &quot;asia-east1-b&quot;
  },
  &quot;builders&quot;: [
    {
      &quot;type&quot;: &quot;googlecompute&quot;,
      &quot;project_id&quot;: &quot;{{user `project_id`}}&quot;,
      &quot;image_name&quot;: &quot;nginx-demo-{{timestamp}}&quot;,
      &quot;source_image&quot;: &quot;centos-7-v20191210&quot;,
      &quot;ssh_username&quot;: &quot;packer&quot;,
      &quot;zone&quot;: &quot;{{user `zone`}}&quot;
    }
  ],
  &quot;provisioners&quot;: [
    {
      &quot;type&quot;: &quot;shell&quot;,
      &quot;inline&quot;: [&quot;sudo yum install -y nginx &amp;&amp; sudo systemctl enable nginx&quot;]
    },
    {
      &quot;type&quot;: &quot;file&quot;,
      &quot;source&quot;: &quot;./index.html&quot;,
      &quot;destination&quot;: &quot;/tmp/index.html&quot;
    },
    {
      &quot;type&quot;: &quot;shell&quot;,
      &quot;inline&quot;: [&quot;sudo mv /tmp/index.html /usr/share/nginx/html/index.html&quot;]
    }
  ]
}
</code></pre>
<p>在 <code>provisioners</code> 區塊執行 3 個步驟：</p>
<ol>
<li>安裝 Nginx</li>
<li>上傳 <code>index.html</code></li>
<li>將 <code>index.html</code> 移至指定目錄下(由於權限關係，所以才分兩步驟做)</li>
</ol>
<p>再次執行驗證與建置</p>
<pre><code>packer validate template.json
packer build template.json
</code></pre>
<p>用建置好的 Image 建立 VM，用瀏覽器訪問就能看到 &ldquo;Hello, Packer!&rdquo; 了。</p>
<p>Reference: <a href=https://github.com/timfanda35/packer-on-gcp-demo/tree/master/nginx>https://github.com/timfanda35/packer-on-gcp-demo/tree/master/nginx</a></p>
</div>
<footer class=post-footer>
<hr>
<div style=margin-top:2.5rem>
<div style=display:flex;justify-content:center;width:100%>
<p style=color:gray>
如果覺得這篇文章對您有所幫助，歡迎贊助我一杯咖啡 ☕️
</p>
</div>
<div style=display:flex;justify-content:center;width:100%>
<p style=color:gray>
祝您有美好的一天 ❤️
</p>
</div>
<div style=display:flex;justify-content:center;width:100%;margin-top:1rem>
<script type=text/javascript src=https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js data-name=bmc-button data-slug=timfanda35 data-color=#FFDD00 data-emoji data-font=Bree data-text="Buy me a coffee" data-outline-color=#000000 data-font-color=#000000 data-coffee-color=#ffffff></script>
</div>
</div>
<hr>
<div style=margin-top:1rem>
<script src=https://utteranc.es/client.js repo=timfanda35/timfanda35.github.io issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script>
</div>
<div class=share>
</div>
<div class=pagenation>
<ul class=pagenation-list>
<li class="pager previous">
<a href=https://blog.bear-su.dev/2019/01/20/jekyll-to-hugo/ data-toggle=tooltip data-placement=top title="從 jekyll 搬到 hugo 筆記">&larr; Previous Post</a>
</li>
<li class="pager next">
<a href=https://blog.bear-su.dev/2020/02/08/packer-on-gcp-with-cloud-build/ data-toggle=tooltip data-placement=top title="Packer on GCP with Cloud Build">Next Post &rarr;</a>
</li>
</ul>
</div>
</footer>
</article>
<article class=related></article>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"NewsArticle","mainEntityOfPage":{"@type":"NewsArticle","@id":"https:\/\/blog.bear-su.dev\/2020\/02\/01\/packer-on-gcp\/","headline":"unsplash-logoAntony Xia想要將在 GCP 建置 GCE VM Image 的過程自動化，又不想寫一堆針對 GCP Service 操作的 Script。可以使用 Hashicorp Packer 來","author":"Bear Su","publisher":{"@type":"Organization","name":"Bear Su","logo":""},"image":"","datePublished":"2020-02-01"},"headline":"unsplash-logoAntony Xia想要將在 GCP 建置 GCE VM Image 的過程自動化，又不想寫一堆針對 GCP Service 操作的 Script。可以使用 Hashicorp Packer 來","alternativeHeadline":"Bear Su\u0027s Blog","datePublished":"2020-02-01","dateModified":"2020-02-01","url":"https:\/\/blog.bear-su.dev\/2020\/02\/01\/packer-on-gcp\/","wordCount":"510","author":{"@type":"Person","name":"Bear Su"},"publisher":{"@type":"Organization","name":"Bear Su"},"image":"","genre":"gcpgcehashicorppacker","description":""}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"Person","@id":"https:\/\/blog.bear-su.dev\/2020\/02\/01\/packer-on-gcp\/","name":"Bear Su"}</script>
</div>
</div>
<footer class=gfooter>
<div class=inner>
<div class=container>
<p class=copy>
<small>Copyright © 2015 - 2022 Bear Su's Blog</small>
<small> | 本部落格有使用 Google Analytic 及 Cookie</small>
</p>
<nav class=footer-nav>
<div class=inner>
</div>
</nav>
</div>
</div>
</footer>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KJXNT5CQCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-KJXNT5CQCS',{anonymize_ip:!1})}</script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://blog.bear-su.dev/js/script.js></script>
</body>
</html>