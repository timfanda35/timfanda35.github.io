<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge,chrome=1">
  <title>透過 jwt 使用 Google Analytics API &middot; Bear Su&#39;s Blog -  Running Bear!!! </title>
  <meta name="generator" content="Hugo 0.53" />
  <meta name="description" content="Running Bear!!!"> 

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="透過 jwt 使用 Google Analytics API"/>
<meta name="twitter:description" content="最近需要希望能夠不用網頁登入就能取得 Gooogle Analytics 的資料

但因為跟 google-api-ruby-client 不熟，只會用網頁登入

在搜尋後看到了這一篇《在伺服器上使用 Google Analytics API》

I got it!!!"/>

  <meta property="og:title" content="透過 jwt 使用 Google Analytics API" />
<meta property="og:description" content="最近需要希望能夠不用網頁登入就能取得 Gooogle Analytics 的資料

但因為跟 google-api-ruby-client 不熟，只會用網頁登入

在搜尋後看到了這一篇《在伺服器上使用 Google Analytics API》

I got it!!!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://timfanda35.github.io/2016/06/15/use-jwt-request-google-analytics-api/" /><meta property="article:published_time" content="2016-06-15T14:21:00&#43;08:00"/>
<meta property="article:modified_time" content="2016-06-15T14:21:00&#43;08:00"/>


  <!-- RSS autodiscovery --> 

  
<meta itemprop="name" content="透過 jwt 使用 Google Analytics API">
<meta itemprop="description" content="最近需要希望能夠不用網頁登入就能取得 Gooogle Analytics 的資料

但因為跟 google-api-ruby-client 不熟，只會用網頁登入

在搜尋後看到了這一篇《在伺服器上使用 Google Analytics API》

I got it!!!">


<meta itemprop="datePublished" content="2016-06-15T14:21:00&#43;08:00" />
<meta itemprop="dateModified" content="2016-06-15T14:21:00&#43;08:00" />
<meta itemprop="wordCount" content="468">



<meta itemprop="keywords" content="" />

  <link href="https://fonts.googleapis.com/css?family=Lato:400" rel="stylesheet">
  <link rel="stylesheet" href="https://timfanda35.github.io/css/style.css">
  <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "WebSite",
  "name": "Bear Su&#39;s Blog",
  "url": "https://timfanda35.github.io/2016/06/15/use-jwt-request-google-analytics-api/"
}
</script>

</head>

<body>
  <header class="gheader">
  <div class="container">
    <nav class="navbar ">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://timfanda35.github.io">
          <p class="brand">Bear Su&#39;s Blog</p>
        </a>

        <div class="navbar-burger burger" data-target="navMenubd-example">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <div id="navMenubd-example" class="navbar-menu">
        <div class="navbar-start">
          
          <a class="navbar-item" href="/categories/">
            Categories
          </a>
          
          <a class="navbar-item" href="https://github.com/timfanda35">
            GitHub
          </a>
          
          <a class="navbar-item" href="https://www.linkedin.com/in/bearsu">
            Linkedin
          </a>
          
          <a class="navbar-item" href="https://twitter.com/Fandayo">
            Twitter
          </a>
          
        </div>
      </div>
    </nav>
  </div>
</header>


  <div class="main-content">
    <div class="container">
      
  <article class="post">
    <header class="post-header">
      <h1 class="title">透過 jwt 使用 Google Analytics API</h1>
      <div class="meta">
        <time class="pub-time"  datetime="2016-06-15T14:21:00&#43;08:00">
          2016.06.15
        </time>
        <div class="terms">
          
          <div class="categories">
            
              <a class="categories-item" href="/categories/ruby">ruby</a>
            
              <a class="categories-item" href="/categories/jwt">jwt</a>
            
          </div>
          
          
        </div>
      </div>
    </header>
    <div class="post-body">
      <p>最近需要希望能夠不用網頁登入就能取得 Gooogle Analytics 的資料</p>

<p>但因為跟 <a href="ref1">google-api-ruby-client</a> 不熟，只會用網頁登入</p>

<p>在搜尋後看到了這一篇<a href="https://zespia.tw/blog/2014/07/28/use-google-analytics-api-on-server/">《在伺服器上使用 Google Analytics API》</a></p>

<p>I got it!!!</p>

<h2 id="設定">設定</h2>

<p>設定就照著 <a href="https://developers.google.com/analytics/devguides/reporting/core/v4/authorization">Analytics Reporting API - Authorization</a> 做</p>

<p>在 <a href="https://console.developers.google.com/">Google Developers Console</a> 建立一個新專案，並啟用 <strong>Analytics API</strong></p>

<p>然後在憑證頁面建立 <strong>服務帳戶金鑰</strong>，並將下載的 <code>JSON</code> 檔案改名成 <code>client-secret.json</code> 稍後使用</p>

<p><img src="http://user-image.logdown.io/user/6114/blog/6123/post/737458/a7I54QGYStublsdKRH0m_1.png" alt="1.png" /></p>

<p>建立好服務帳戶後，點擊管理服務帳戶，</p>

<p><img src="http://user-image.logdown.io/user/6114/blog/6123/post/737458/ACst1ndT0GLmbn3AIxEA_2.png" alt="2.png" /></p>

<p>複製剛剛新增的服務帳戶的<strong>服務帳戶 ID</strong></p>

<p><img src="http://user-image.logdown.io/user/6114/blog/6123/post/737458/pC6xYwZQTIKckGKNmUtv_3.png" alt="3.png" /></p>

<p>到 <a href="https://analytics.google.com">Google Analytics</a> 的管理頁面，點擊<strong>資源</strong>下的<strong>使用者管理</strong></p>

<p><img src="http://user-image.logdown.io/user/6114/blog/6123/post/737458/4VRh5c2pQVOAp2fdPTla_4.png" alt="4.png" /></p>

<p>加入剛剛複製的<strong>服務帳戶 ID</strong></p>

<p><img src="http://user-image.logdown.io/user/6114/blog/6123/post/737458/zerjIhaQaCk5872MgOow_5.png" alt="5.png" /></p>

<p>再到 <a href="https://analytics.google.com">Google Analytics</a> 的管理頁面，點擊<strong>資料檢視</strong>下的<strong>檢視設定</strong></p>

<p>複製 <strong>資料檢視編號</strong> 稍後使用</p>

<p><img src="http://user-image.logdown.io/user/6114/blog/6123/post/737458/VPzNGyZ5T76E4LjPmJ8v_6.png" alt="6.png" /></p>

<h2 id="coding">Coding</h2>

<p>立即來段程式碼 <code>main.rb</code>，記得修改 <code>ga_id</code> 的值</p>

<p>在同一目錄下放置設定步驟所下載的 <code>client-secret.json</code></p>

<p>執行指令為： <code>ruby main.rb</code></p>

<p>在這之前，你可能會需要執行 <code>gem install oj jwt faraday awesome_print</code> 安裝依賴的 gem</p>

<pre><code class="language-ruby"># main.rb

require 'oj'
require 'jwt'
require 'faraday'
require 'awesome_print'

# 將設定步驟所下載的 JSON 改名成 client-secret.json
# 並放置在此 .rb 檔在相同的目錄下
# 以下將 client-secret.json 的內容讀取至 config hash 中
secert_json_path = File.expand_path('../client-secret.json', __FILE__)

unless File.exist?(secert_json_path)
  puts &quot;client-secret.json not found!!!&quot;
  exit
end

secert_json = File.read(secert_json_path)
config = Oj.load(secert_json)

# 產生 jwt sign ，這裡使用 jwt gem
# 依照 Google 說明文件建立 body 的部分
# 再透過 jwt gem 用 private key 對 jwt_body 簽名產生所需要的字串
jwt_body = {
  &quot;iss&quot;: config['client_email'],
  &quot;scope&quot;: &quot;https://www.googleapis.com/auth/analytics.readonly&quot;,
  &quot;aud&quot;: &quot;https://www.googleapis.com/oauth2/v4/token&quot;,
  &quot;iat&quot;: Time.now.to_i,
  &quot;exp&quot;: Time.now.to_i + 3600
}

rsa_private = OpenSSL::PKey::RSA.new(config['private_key'])
jwt_sign = JWT.encode jwt_body, rsa_private, 'RS256'

# 這裡利用 faraday gem 送出 post 請求
# 參數依照 Google 說明文件設定
conn = Faraday.new(:url =&gt; 'https://www.googleapis.com') do |faraday|
  faraday.request  :url_encoded
  faraday.adapter  Faraday.default_adapter
end

resp = conn.post do |req|
  req.url '/oauth2/v4/token'
  req.body = {
    grant_type: &quot;urn:ietf:params:oauth:grant-type:jwt-bearer&quot;,
    assertion: jwt_sign
  }
end

jwt_token =  Oj.load(resp.body)
puts &quot;jwt_token&quot;
ap jwt_token

#回傳成功，取得時效為 3,600 秒的 jwt token
#{
#    &quot;access_token&quot; =&gt; &quot;bla bla token&quot;,
#      &quot;token_type&quot; =&gt; &quot;Bearer&quot;,
#      &quot;expires_in&quot; =&gt; 3600
#}

# 這裡使用 V3 API 做示範
# ga_id 填入設定步驟取得的&quot;資料檢視編號&quot;
ga_id = &quot;replace to your info&quot;
ga_resp = conn.get do |req|
  req.url '/analytics/v3/data/ga'
  req.headers['Authorization'] = &quot;Bearer #{jwt_token['access_token']}&quot;
  req.params = {
    &quot;ids&quot;: &quot;ga:#{ga_id}&quot;,
    &quot;start-date&quot;: Time.now.strftime(&quot;%Y-%m-01&quot;),
    &quot;end-date&quot;: Time.now.strftime(&quot;%Y-%m-%d&quot;),
    &quot;metrics&quot;: &quot;ga:sessions,ga:bounces&quot;
  }
end

puts &quot;ga response&quot;
ap Oj.load(ga_resp.body)

# 請求成功就可以取得 JSON 資料了
# {
#                    &quot;kind&quot; =&gt; &quot;analytics#gaData&quot;,
#                      &quot;id&quot; =&gt; &quot;https://www.googleapis.com/analytics/v3/data/ga?ids=ga:---------&amp;metrics=ga:sessions,ga:bounces&amp;start-date=2016-06-01&amp;end-date=2016-06-15&quot;,
#                   &quot;query&quot; =&gt; {
#          &quot;start-date&quot; =&gt; &quot;2016-06-01&quot;,
#            &quot;end-date&quot; =&gt; &quot;2016-06-15&quot;,
#                 &quot;ids&quot; =&gt; &quot;ga:---------&quot;,
#             &quot;metrics&quot; =&gt; [
#             [0] &quot;ga:sessions&quot;,
#             [1] &quot;ga:bounces&quot;
#         ],
#         &quot;start-index&quot; =&gt; 1,
#         &quot;max-results&quot; =&gt; 1000
#     },
#            &quot;itemsPerPage&quot; =&gt; 1000,
#            &quot;totalResults&quot; =&gt; 1,
#                &quot;selfLink&quot; =&gt; &quot;https://www.googleapis.com/analytics/v3/data/ga?ids=ga:---------&amp;metrics=ga:sessions,ga:bounces&amp;start-date=2016-06-01&amp;end-date=2016-06-15&quot;,
#             &quot;profileInfo&quot; =&gt; {
#                     &quot;profileId&quot; =&gt; &quot;---------&quot;,
#                     &quot;accountId&quot; =&gt; &quot;---------&quot;,
#                 &quot;webPropertyId&quot; =&gt; &quot;UA-----------&quot;,
#         &quot;internalWebPropertyId&quot; =&gt; &quot;---------&quot;,
#                   &quot;profileName&quot; =&gt; &quot;所有網站資料&quot;,
#                       &quot;tableId&quot; =&gt; &quot;ga:---------&quot;
#     },
#     &quot;containsSampledData&quot; =&gt; false,
#           &quot;columnHeaders&quot; =&gt; [
#         [0] {
#                   &quot;name&quot; =&gt; &quot;ga:sessions&quot;,
#             &quot;columnType&quot; =&gt; &quot;METRIC&quot;,
#               &quot;dataType&quot; =&gt; &quot;INTEGER&quot;
#         },
#         [1] {
#                   &quot;name&quot; =&gt; &quot;ga:bounces&quot;,
#             &quot;columnType&quot; =&gt; &quot;METRIC&quot;,
#               &quot;dataType&quot; =&gt; &quot;INTEGER&quot;
#         }
#     ],
#     &quot;totalsForAllResults&quot; =&gt; {
#         &quot;ga:sessions&quot; =&gt; &quot;106&quot;,
#          &quot;ga:bounces&quot; =&gt; &quot;89&quot;
#     },
#                    &quot;rows&quot; =&gt; [
#         [0] [
#             [0] &quot;106&quot;,
#             [1] &quot;89&quot;
#         ]
#     ]
# }
</code></pre>

<p>接下來就是嗑文件開發符合需求的功能了！</p>

<h2 id="參考">參考</h2>

<p><a href="https://zespia.tw/blog/2014/07/28/use-google-analytics-api-on-server/">《在伺服器上使用 Google Analytics API》</a></p>

<p><a href="https://developers.google.com/analytics/devguides/reporting/core/v4/authorization">Analytics Reporting API - Authorization</a></p>

<p><a href="https://developers.google.com/analytics/devguides/reporting/core/v4/migration">Migrate Analytics API V3 to V4</a></p>

<p><a href="https://developers.google.com/analytics/devguides/reporting/core/dimsmets">Dimensions &amp; Metrics Explorer</a></p>

<p><a href="https://developers.google.com/analytics/devguides/reporting/core/v3/reference">API - Reference Guide</a></p>
    </div>
    <footer class="post-footer">
      
      <div class="share">
        
      </div>

      <div class="pagenation">
        <ul class="pagenation-list">
          
          <li class="pager previous">
            <a href="https://timfanda35.github.io/2016/06/13/rails-hosting-survey-2016/" data-toggle="tooltip" data-placement="top" title="Rails Hosting Survey 2016">&larr; Previous Post</a>
          </li>
          
          
          <li class="pager next">
            <a href="https://timfanda35.github.io/2016/07/27/elixir-char-list/" data-toggle="tooltip" data-placement="top" title="Elixir Char List">Next Post &rarr;</a>
          </li>
          
        </ul>
      </div>
    </footer>
  </article>

  
  <article class="related"></article>

  <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "NewsArticle",
  "mainEntityOfPage": {
    "@type": "NewsArticle",
    "@id": "https://timfanda35.github.io/2016/06/15/use-jwt-request-google-analytics-api/",
    "headline": "最近需要希望能夠不用網頁登入就能取得 Gooogle Analytics 的資料但因為跟 google-api-ruby-client 不熟，只會用網頁登入在搜尋後看到了這一篇《在伺服器上使用 Google Analyt",
    "author": "Bear Su",
    "publisher": {
      "@type": "Organization",
      "name": "Bear Su",
      "logo": ""
    },
    "image": "",
    "datePublished": "2016-06-15"
  },
  "headline": "最近需要希望能夠不用網頁登入就能取得 Gooogle Analytics 的資料但因為跟 google-api-ruby-client 不熟，只會用網頁登入在搜尋後看到了這一篇《在伺服器上使用 Google Analyt",
  "alternativeHeadline": "Bear Su&#39;s Blog",
  "datePublished": "2016-06-15",
  "dateModified": "2016-06-15",
  "url": "https://timfanda35.github.io/2016/06/15/use-jwt-request-google-analytics-api/",
  "wordCount": "468",
  "author": {
    "@type": "Person",
    "name": "Bear Su"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Bear Su"
  },
  "image": "",
  "genre": "rubyjwt",
  
  "description": ""
}
</script>

  <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Person",
  "@id": "https://timfanda35.github.io/2016/06/15/use-jwt-request-google-analytics-api/",
  "name": "Bear Su"
}
</script>


    </div>
  </div>

  <footer class="gfooter">
  <div class="inner">
    <div class="container">
      <p class="copy"><small>(c) 2019 Bear Su&#39;s Blog</small></p>

      <nav class="footer-nav">
        <div class="inner">
          
        </div>
      </nav>
    </div>
  </div>
</footer>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5708312-7', 'auto');
	
	ga('send', 'pageview');
}
</script>


<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script src="https://timfanda35.github.io/js/script.js"></script>

</body>
</html>
