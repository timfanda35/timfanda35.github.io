<!doctype html><html lang=en-us>
<head>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<meta name=msapplication-TileColor content="#da532c">
<meta name=theme-color content="#ffffff">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge,chrome=1">
<title>用快取加速 Cloud Build 建置容器 &#183; Bear Su's Blog - Running Bear!!! </title>
<meta name=generator content="Hugo 0.92.0">
<meta name=description content="Running Bear!!!">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.bear-su.dev/images/bear.jpeg">
<meta name=twitter:title content="用快取加速 Cloud Build 建置容器">
<meta name=twitter:description content="
圖片來源
フリー写真素材ぱくたそ
參考至 Google Cloud Platform Cloud Build 官方文件：Speeding up your Builds
可以使用之前建置過的 Docker Image 來當作快取，來加快建置 Docker Image 的速度
這方法需要使用 cloudbuild.yaml
使用方式：
gcloud builds submit --config cloudbuild.yaml .
或是在設定 cloud build trigger 時指定使用 cloudbuild.yaml">
<meta property="og:title" content="用快取加速 Cloud Build 建置容器">
<meta property="og:description" content="
圖片來源
フリー写真素材ぱくたそ
參考至 Google Cloud Platform Cloud Build 官方文件：Speeding up your Builds
可以使用之前建置過的 Docker Image 來當作快取，來加快建置 Docker Image 的速度
這方法需要使用 cloudbuild.yaml
使用方式：
gcloud builds submit --config cloudbuild.yaml .
或是在設定 cloud build trigger 時指定使用 cloudbuild.yaml">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.bear-su.dev/2018/09/01/cloudbuild-with-cache/"><meta property="og:image" content="https://blog.bear-su.dev/images/bear.jpeg"><meta property="article:section" content>
<meta property="article:published_time" content="2018-09-01T14:40:00+08:00">
<meta property="article:modified_time" content="2018-09-01T14:40:00+08:00">
<link href rel=alternate type=application/rss+xml title="Bear Su's Blog">
<link href rel=feed type=application/rss+xml title="Bear Su's Blog">
<meta itemprop=name content="用快取加速 Cloud Build 建置容器">
<meta itemprop=description content="
圖片來源
フリー写真素材ぱくたそ
參考至 Google Cloud Platform Cloud Build 官方文件：Speeding up your Builds
可以使用之前建置過的 Docker Image 來當作快取，來加快建置 Docker Image 的速度
這方法需要使用 cloudbuild.yaml
使用方式：
gcloud builds submit --config cloudbuild.yaml .
或是在設定 cloud build trigger 時指定使用 cloudbuild.yaml"><meta itemprop=datePublished content="2018-09-01T14:40:00+08:00">
<meta itemprop=dateModified content="2018-09-01T14:40:00+08:00">
<meta itemprop=wordCount content="139"><meta itemprop=image content="https://blog.bear-su.dev/images/bear.jpeg">
<meta itemprop=keywords content>
<link href="https://fonts.googleapis.com/css?family=Lato:400" rel=stylesheet>
<link rel=stylesheet href=https://blog.bear-su.dev/css/style.css>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Bear Su\u0027s Blog","url":"https:\/\/blog.bear-su.dev\/2018\/09\/01\/cloudbuild-with-cache\/"}</script>
</head>
<body>
<header class=gheader>
<div class=container>
<nav class=navbar>
<div class=navbar-brand>
<a class=navbar-item href=https://blog.bear-su.dev>
<p class=brand>Bear Su's Blog</p>
</a>
<div class="navbar-burger burger" data-target=navMenubd-example>
<span></span>
<span></span>
<span></span>
</div>
</div>
<div id=navMenubd-example class=navbar-menu>
<div class=navbar-start>
<a class=navbar-item href=/categories/>
Categories
</a>
<a class=navbar-item href=https://github.com/timfanda35>
GitHub
</a>
<a class=navbar-item href=https://www.linkedin.com/in/bearsu>
Linkedin
</a>
<a class=navbar-item href=https://twitter.com/Fandayo>
Twitter
</a>
</div>
</div>
</nav>
</div>
</header>
<div class=main-content>
<div class=container>
<article class=post>
<header class=post-header>
<h1 class=title>用快取加速 Cloud Build 建置容器</h1>
<div class=meta>
<time class=pub-time datetime=2018-09-01T14:40:00+08:00>
2018.09.01
</time>
<div class=terms>
<div class=categories>
<a class=categories-item href=/categories/gcp>gcp</a>
<a class=categories-item href=/categories/cloudbuild>cloudbuild</a>
<a class=categories-item href=/categories/container>container</a>
</div>
</div>
</div>
</header>
<div class=post-body>
<div class=toc-wrap>
<h2>Table of Contents</h2>
<nav id=TableOfContents></nav>
</div>
<p><img src=https://i.imgur.com/EsiorQx.jpg alt></p>
<p><a href=https://www.pakutaso.com/20160628181pc-11.html>圖片來源</a>
<a href=https://www.pakutaso.com/>フリー写真素材ぱくたそ</a></p>
<p>參考至 Google Cloud Platform Cloud Build 官方文件：<a href=https://cloud.google.com/cloud-build/docs/speeding-up-builds>Speeding up your Builds</a></p>
<p>可以使用之前建置過的 Docker Image 來當作快取，來加快建置 Docker Image 的速度</p>
<p>這方法需要使用 <code>cloudbuild.yaml</code></p>
<p>使用方式：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>gcloud builds submit --config cloudbuild.yaml .
</code></pre></div><p>或是在設定 cloud build trigger 時指定使用 <code>cloudbuild.yaml</code></p>
<p>官方文件上的設定如下，不過這是在 Container Registry 已經有 <code>gcr.io/$PROJECT_ID/[IMAGE_NAME]:latest</code> 的前提下才能順利完成建置步驟。</p>
<p>若是從一開始就使用以下 <code>cloudbuild.yaml</code> 的話，在 Step 0 就會因為無法 pull <code>gcr.io/$PROJECT_ID/[IMAGE_NAME]:latest</code> 而停止建構</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>steps</span>:
- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;gcr.io/cloud-builders/docker&#39;</span>
  <span style=color:#f92672>args</span>: [<span style=color:#e6db74>&#39;pull&#39;</span>, <span style=color:#e6db74>&#39;gcr.io/$PROJECT_ID/[IMAGE_NAME]:latest&#39;</span>]
- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;gcr.io/cloud-builders/docker&#39;</span>
  <span style=color:#f92672>args</span>: [
            <span style=color:#e6db74>&#39;build&#39;</span>,
            <span style=color:#e6db74>&#39;-t&#39;</span>, <span style=color:#e6db74>&#39;gcr.io/$PROJECT_ID/[IMAGE_NAME]:latest&#39;</span>,
            <span style=color:#e6db74>&#39;--cache-from&#39;</span>, <span style=color:#e6db74>&#39;gcr.io/$PROJECT_ID/[IMAGE_NAME]:latest&#39;</span>,
            <span style=color:#e6db74>&#39;.&#39;</span>
        ]
<span style=color:#f92672>images</span>: [<span style=color:#e6db74>&#39;gcr.io/$PROJECT_ID/[IMAGE_NAME]:latest&#39;</span>]
</code></pre></div><p>因為不想要每次都要先自己手動建置一版推上 Container Registry 再修改 <code>cloudbuild.yaml</code></p>
<p>所以將 Step 0 改成不管有沒有存在 <code>gcr.io/$PROJECT_ID/[IMAGE_NAME]:latest</code>，都讓 Step 0 通過建置</p>
<p>透過 <code>|| true</code> 可以讓該行指令的回傳值為 <code>0</code>，從而表示通過建置</p>
<p>這樣就可以在直接從專案初期就使用同一份 <code>cloudbuild.yaml</code> 了</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>steps</span>:
- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;gcr.io/cloud-builders/docker&#39;</span>
  <span style=color:#f92672>entrypoint</span>: <span style=color:#e6db74>&#39;bash&#39;</span>
  <span style=color:#f92672>args</span>: [
    <span style=color:#e6db74>&#39;-c&#39;</span>,
    <span style=color:#e6db74>&#39;/usr/bin/docker pull gcr.io/${PROJECT_ID}/${REPO_NAME}:latest || true&#39;</span>
  ]
- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;gcr.io/cloud-builders/docker&#39;</span>
  <span style=color:#f92672>args</span>: [
    <span style=color:#e6db74>&#39;build&#39;</span>,
    <span style=color:#e6db74>&#39;-t&#39;</span>, <span style=color:#e6db74>&#39;gcr.io/${PROJECT_ID}/${REPO_NAME}:latest&#39;</span>,
    <span style=color:#e6db74>&#39;-t&#39;</span>, <span style=color:#e6db74>&#39;gcr.io/${PROJECT_ID}/${REPO_NAME}:${SHORT_SHA}&#39;</span>,
    <span style=color:#e6db74>&#39;--cache-from&#39;</span>, <span style=color:#e6db74>&#39;gcr.io/${PROJECT_ID}/${REPO_NAME}:latest&#39;</span>,
    <span style=color:#e6db74>&#39;.&#39;</span>
    ]
<span style=color:#f92672>images</span>: [
  <span style=color:#e6db74>&#39;gcr.io/${PROJECT_ID}/${REPO_NAME}:${SHORT_SHA}&#39;</span>, 
  <span style=color:#e6db74>&#39;gcr.io/${PROJECT_ID}/${REPO_NAME}:latest&#39;</span>
  ]
</code></pre></div><p>其他參考：</p>
<ul>
<li><a href=https://cloud.google.com/cloud-build/>Supported builder images for Google Cloud Build</a></li>
<li><a href=https://github.com/GoogleCloudPlatform/cloud-builders-community>Community-contributed images for Google Cloud Build</a></li>
</ul>
</div>
<footer class=post-footer>
<hr>
<div style=margin-top:2.5rem>
<div style=display:flex;justify-content:center;width:100%>
<p style=color:gray>
如果覺得這篇文章對您有所幫助，歡迎贊助我一杯咖啡 ☕️
</p>
</div>
<div style=display:flex;justify-content:center;width:100%>
<p style=color:gray>
祝您有美好的一天 ❤️
</p>
</div>
<div style=display:flex;justify-content:center;width:100%;margin-top:1rem>
<script type=text/javascript src=https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js data-name=bmc-button data-slug=timfanda35 data-color=#FFDD00 data-emoji data-font=Bree data-text="Buy me a coffee" data-outline-color=#000000 data-font-color=#000000 data-coffee-color=#ffffff></script>
</div>
</div>
<hr>
<div style=margin-top:1rem>
<script src=https://utteranc.es/client.js repo=timfanda35/timfanda35.github.io issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script>
</div>
<div class=share>
</div>
<div class=pagenation>
<ul class=pagenation-list>
<li class="pager previous">
<a href=https://blog.bear-su.dev/2017/05/17/ruby-by-using-treetype-to-draw-text-to-a-ascii-art/ data-toggle=tooltip data-placement=top title="Ruby 透過 FreeType 產生點陣文字">&larr; Previous Post</a>
</li>
<li class="pager next">
<a href=https://blog.bear-su.dev/2018/09/01/create-cloudbuild-trigger-with-command/ data-toggle=tooltip data-placement=top title="用指令建立 Cloud Build Trigger">Next Post &rarr;</a>
</li>
</ul>
</div>
</footer>
</article>
<article class=related></article>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"NewsArticle","mainEntityOfPage":{"@type":"NewsArticle","@id":"https:\/\/blog.bear-su.dev\/2018\/09\/01\/cloudbuild-with-cache\/","headline":"圖片來源 フリー写真素材ぱくたそ參考至 Google Cloud Platform Cloud Build 官方文件：Speeding up your Builds可以使用之前建置過的 Docker Image 來當作快","author":"Bear Su","publisher":{"@type":"Organization","name":"Bear Su","logo":""},"image":"","datePublished":"2018-09-01"},"headline":"圖片來源 フリー写真素材ぱくたそ參考至 Google Cloud Platform Cloud Build 官方文件：Speeding up your Builds可以使用之前建置過的 Docker Image 來當作快","alternativeHeadline":"Bear Su\u0027s Blog","datePublished":"2018-09-01","dateModified":"2018-09-01","url":"https:\/\/blog.bear-su.dev\/2018\/09\/01\/cloudbuild-with-cache\/","wordCount":"139","author":{"@type":"Person","name":"Bear Su"},"publisher":{"@type":"Organization","name":"Bear Su"},"image":"","genre":"gcpcloudbuildcontainer","description":""}</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"Person","@id":"https:\/\/blog.bear-su.dev\/2018\/09\/01\/cloudbuild-with-cache\/","name":"Bear Su"}</script>
</div>
</div>
<footer class=gfooter>
<div class=inner>
<div class=container>
<p class=copy>
<small>Copyright © 2015 - 2022 Bear Su's Blog</small>
<small> | 本部落格有使用 Google Analytic 及 Cookie</small>
</p>
<nav class=footer-nav>
<div class=inner>
</div>
</nav>
</div>
</div>
</footer>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KJXNT5CQCS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-KJXNT5CQCS',{anonymize_ip:!1})}</script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://blog.bear-su.dev/js/script.js></script>
</body>
</html>